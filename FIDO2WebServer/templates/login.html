<form id="login-form">
    Username: <input type="text" name="username" id="username" required>
    <button type="submit">Login with Security Key</button>
  </form>
  <div id="msg"></div>
  <script>
  document.getElementById('login-form').onsubmit = async (e) => {
    e.preventDefault();
    let username = document.getElementById('username').value;
  
    let resp = await fetch('/login/begin', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username})});
    if (!resp.ok) { document.getElementById('msg').innerText = "No such user"; return;}
    let options = await resp.json();
  
    options.challenge = Uint8Array.from(atob(options.challenge.replace(/_/g, '/').replace(/-/g, '+')), c => c.charCodeAt(0));
    options.allowCredentials = options.allowCredentials.map(ac => {
      ac.id = Uint8Array.from(atob(ac.id.replace(/_/g, '/').replace(/-/g, '+')), c => c.charCodeAt(0));
      return ac;
    });
  
    let cred = await navigator.credentials.get({publicKey: options});
  
    let credential = {
      id: cred.id,
      rawId: btoa(String.fromCharCode(...new Uint8Array(cred.rawId))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''),
      type: cred.type,
      response: {
        clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(cred.response.clientDataJSON))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''),
        authenticatorData: btoa(String.fromCharCode(...new Uint8Array(cred.response.authenticatorData))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''),
        signature: btoa(String.fromCharCode(...new Uint8Array(cred.response.signature))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''),
        userHandle: cred.response.userHandle ? btoa(String.fromCharCode(...new Uint8Array(cred.response.userHandle))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '') : null
      }
    };
  
    let finalResp = await fetch('/login/complete', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({credential})});
    let data = await finalResp.json();
    if(data.success) document.getElementById('msg').innerText = "Login success!";
    else document.getElementById('msg').innerText = "Login failed.";
  }
  </script>